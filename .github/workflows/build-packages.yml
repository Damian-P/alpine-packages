name: Build and Publish APKs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect-packages:
    name: Detect modified packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set-packages.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pour pouvoir comparer avec origin/main

      - id: set-packages
        run: |
          # Détecte les APKBUILD modifiés sous main/
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # Pour les PR, compare avec la branche de base
            pkgs=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^main/.*/APKBUILD' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            # Pour les push sur main, regarde le dernier commit
            pkgs=$(git diff --name-only HEAD~1 HEAD | grep '^main/.*/APKBUILD' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          fi
          echo "Detected packages: $pkgs"
          echo "packages=$pkgs" >> "$GITHUB_OUTPUT"

  build:
    name: Build APKs multi-arch
    needs: detect-packages
    runs-on: ubuntu-latest
    if: ${{ needs.detect-packages.outputs.packages != '' }}
    strategy:
      matrix:
        arch: [x86_64]
        # Les paquets seront passés via un input custom (bash) dans le job build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Alpine ${{ matrix.arch }}
        uses: jirutka/setup-alpine@v1
        with:
          arch: ${{ matrix.arch }}
          packages: doas sudo build-base alpine-sdk

      - name: Setup doas configuration
        shell: alpine.sh {0}
        run: |
          mkdir -p /etc/doas.d
          cp ${{ github.workspace }}/.ci/doas-abuild.conf /etc/doas.d/abuild.conf

      # Les paquets requis sont déjà installés par setup-alpine

      - name: Create builder user and permissions
        shell: alpine.sh {0}
        run: |
          doas adduser -D builder
          doas addgroup builder abuild || true
          doas adduser builder abuild || true
          doas chown -R builder:abuild $GITHUB_WORKSPACE

      - name: Setup abuild keys
        shell: alpine.sh {0}
        run: |
          doas -u builder mkdir -p /home/builder/.abuild
          echo "${{ secrets.ABUILD_PRIVKEY }}" | doas -u builder tee /home/builder/.abuild/privkey.rsa > /dev/null
          doas -u builder chmod 600 /home/builder/.abuild/privkey.rsa
          # Configure abuild to use the provided key
          echo "PACKAGER=CI Builder <ci@example.com>" | doas -u builder tee /home/builder/.abuild/abuild.conf > /dev/null
          echo "PACKAGER_PRIVKEY=/home/builder/.abuild/privkey.rsa" | doas -u builder tee -a /home/builder/.abuild/abuild.conf > /dev/null

      - name: Generate abuild public key
        shell: alpine.sh {0}
        run: |
          # Generate public key from the configured private key by re-keygen (creates .pub if missing)
          doas -u builder sh -lc 'abuild-keygen -n -a || true'
          mkdir -p keys
          cp /home/builder/.abuild/*.pub keys/alpine.pub || true

      - name: Build detected packages
        shell: alpine.sh {0}
        run: |
          pkgs="${{ needs.detect-packages.outputs.packages }}"
          echo "Packages to build: $pkgs"
          mkdir -p output/${{ matrix.arch }}

          for pkg in $pkgs; do
            echo "Building $pkg"
            cd main/$pkg
            # Build as non-root user
            doas -u builder sh -lc "cd '$GITHUB_WORKSPACE/main/$pkg' && abuild -r"
            # Copy only the APKs for the current package from builder's packages dir
            find /home/builder/packages/main/${{ matrix.arch }}/ -name "${pkg}-*.apk" -exec cp {} $GITHUB_WORKSPACE/output/${{ matrix.arch }}/ \; 2>/dev/null || true
            cd $GITHUB_WORKSPACE
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.arch }}
          path: output/${{ matrix.arch }}

      - name: Upload public key (single arch)
        if: ${{ matrix.arch == 'x86_64' }}
        uses: actions/upload-artifact@v4
        with:
          name: keys
          path: keys/alpine.pub

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./public

      - name: Copy public key
        run: |
          mkdir -p public
          # La clé est publiée en tant qu'artefact "keys"
          if [ -f public/keys/alpine.pub ]; then
            cp public/keys/alpine.pub public/
          else
            echo "Warning: public key not found; continuing without it"
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
