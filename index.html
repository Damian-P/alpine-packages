<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine Linux Packages</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .arch-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .arch-title {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .package-list {
            list-style: none;
            padding: 0;
        }
        .package-item {
            margin: 0.5rem 0;
            padding: 1rem;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .package-link {
            color: #2d3748;
            text-decoration: none;
            font-family: 'SFMono-Regular', monospace;
            font-size: 0.9rem;
        }
        .package-link:hover {
            color: #667eea;
        }
        .setup-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e2e8f0;
            border-radius: 8px;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .key-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fef5e7;
            border-left: 4px solid #f6ad55;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
            font-style: italic;
        }
        .error {
            background-color: #fed7d7;
            border-left: 4px solid #fc8181;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            color: #742a2a;
        }
        .package-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .package-size {
            color: #718096;
            font-size: 0.8rem;
            font-family: 'SFMono-Regular', monospace;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèîÔ∏è Alpine Linux Packages</h1>
        <p>Repository de packages Alpine Linux construits automatiquement</p>
    </div>

    <div id="packages-container">
        <div class="loading">ÔøΩ Chargement des packages...</div>
    </div>

    <div class="setup-section">
        <h2>üîß Configuration</h2>
        <p>Pour utiliser ce repository avec Alpine Linux :</p>
        
        <div class="key-info">
            <strong>1. T√©l√©charger et installer la cl√© publique :</strong>
        </div>
        <pre>wget https://damian-p.github.io/alpine-packages/alpine.pub -O /etc/apk/keys/alpine.pub</pre>

        <div class="key-info">
            <strong>2. Ajouter le repository √† votre configuration APK :</strong>
        </div>
        <pre>echo "https://damian-p.github.io/alpine-packages/apk-$(uname -m)" >> /etc/apk/repositories</pre>

        <div class="key-info">
            <strong>3. Mettre √† jour l'index des packages :</strong>
        </div>
        <pre>apk update</pre>

        <div class="key-info">
            <strong>4. Installer un package :</strong>
        </div>
        <pre>apk add hello-test</pre>
    </div>

    <div class="key-info">
        <h3>üîë Cl√© publique</h3>
        <p>Cl√© publique de signature des packages : <a href="alpine.pub">alpine.pub</a></p>
    </div>

    <footer style="text-align: center; margin-top: 2rem; color: #718096; font-size: 0.9rem;">
        <p>Construit automatiquement avec GitHub Actions ‚Ä¢ <a href="https://github.com/Damian-P/alpine-packages" style="color: #667eea;">Source sur GitHub</a></p>
    </footer>

    <script>
        async function discoverPackages() {
            const container = document.getElementById('packages-container');

            try {
                // Essayer d'abord de r√©cup√©rer le manifest JSON g√©n√©r√© automatiquement
                try {
                    const response = await fetch('manifest.json');
                    if (response.ok) {
                        const manifest = await response.json();
                        if (manifest.packages && Object.keys(manifest.packages).length > 0) {
                            renderPackagesFromManifest(manifest.packages);
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Manifest JSON non disponible, utilisation de la m√©thode de fallback');
                }

                // Fallback: m√©thode originale de d√©couverte
                await discoverPackagesFallback();
                
            } catch (error) {
                console.error('Erreur lors de la d√©couverte des packages:', error);
                container.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur lors du chargement des packages. Veuillez r√©essayer plus tard.
                    </div>
                `;
            }
        }

        async function discoverPackagesFallback() {
            const container = document.getElementById('packages-container');
            const architectures = ['x86_64', 'aarch64'];
            const packages = {};

            for (const arch of architectures) {
                packages[arch] = [];
                
                // Essayer des packages connus
                const knownPackages = ['hello-test-1.0.5-r1.apk'];
                for (const pkg of knownPackages) {
                    try {
                        const response = await fetch(`apk-${arch}/${pkg}`, { method: 'HEAD' });
                        if (response.ok) {
                            const size = response.headers.get('content-length');
                            packages[arch].push({
                                name: pkg.replace(/-[0-9].*/, ''), // nom du package
                                version: pkg.match(/-([0-9][^-]*-r[0-9]*)/)?.[1] || 'unknown',
                                filename: pkg,
                                size: size ? parseInt(size) : 0,
                                arch: arch
                            });
                        }
                    } catch (e) {
                        // Ignorer les erreurs pour les packages qui n'existent pas
                    }
                }
            }

            renderPackagesFromManifest(packages);
        }

        function renderPackagesFromManifest(packages) {
            const container = document.getElementById('packages-container');
            let html = '';
            let totalPackages = 0;

            for (const [arch, packageList] of Object.entries(packages)) {
                if (packageList.length > 0) {
                    totalPackages += packageList.length;
                    const archEmoji = arch === 'x86_64' ? 'üñ•Ô∏è' : 'üì±';
                    html += `
                        <div class="arch-section">
                            <h2 class="arch-title">${archEmoji} ${arch} Packages (${packageList.length})</h2>
                            <ul class="package-list">
                    `;

                    // Trier les packages par nom
                    const sortedPackages = packageList.sort((a, b) => a.name.localeCompare(b.name));

                    sortedPackages.forEach(pkg => {
                        const sizeFormatted = pkg.size ? formatBytes(pkg.size) : 'Taille inconnue';
                        html += `
                            <li class="package-item">
                                <div class="package-info">
                                    <div>
                                        <a href="apk-${arch}/${pkg.filename}" class="package-link">${pkg.name}</a>
                                        <div style="font-size: 0.8rem; color: #718096; margin-top: 0.2rem;">
                                            Version: ${pkg.version}
                                        </div>
                                    </div>
                                    <span class="package-size">${sizeFormatted}</span>
                                </div>
                            </li>
                        `;
                    });

                    html += `
                            </ul>
                        </div>
                    `;
                }
            }

            if (totalPackages === 0) {
                html = `
                    <div class="error">
                        ‚ÑπÔ∏è Aucun package disponible pour le moment.
                    </div>
                `;
            }

            container.innerHTML = html;
            
            // Mettre √† jour le titre avec le nombre total de packages
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle && totalPackages > 0) {
                headerTitle.textContent = `üèîÔ∏è Alpine Linux Packages (${totalPackages})`;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function renderPackages(packages) {
            // Cette fonction est maintenant remplac√©e par renderPackagesFromManifest
            renderPackagesFromManifest(packages);
        }

        // Lancer la d√©couverte automatique au chargement de la page
        document.addEventListener('DOMContentLoaded', discoverPackages);

        // Rafra√Æchir toutes les 5 minutes
        setInterval(discoverPackages, 5 * 60 * 1000);
    </script>
</body>
</html>
